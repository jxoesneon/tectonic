name: Stellar CI

on:
  push:
    branches:
      - local/ferrotex-vendor-v2
      - master
  pull_request:
    branches:
      - local/ferrotex-vendor-v2
      - master

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install cargo-audit
        uses: taiki-e/install-action@cargo-audit
      - name: Run audit
        run: cargo audit

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Install pkg-config dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfontconfig1-dev libgraphite2-dev libharfbuzz-dev libicu-dev libssl-dev zlib1g-dev
      - name: Run Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  test:
    name: Test
    needs: [audit, fmt, clippy]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      # Linux Deps
      - name: Install Linux Deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfontconfig1-dev libgraphite2-dev libharfbuzz-dev libicu-dev libssl-dev zlib1g-dev

      # macOS Deps (Homebrew)
      - name: Install macOS Deps
        if: runner.os == 'macOS'
        run: |
          brew install graphite2 harfbuzz icu4c openssl
          echo "PKG_CONFIG_PATH=$(brew --prefix icu4c)/lib/pkgconfig:$(brew --prefix openssl)/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

      # Windows Deps (vcpkg)
      - name: Install vcpkg dependencies
        if: runner.os == 'Windows'
        uses: ./.github/actions/vcpkg-deps
        with:
          target: ${{ matrix.target }}

      - name: Setup build variables (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "TECTONIC_DEP_BACKEND=vcpkg" >> "$GITHUB_ENV"
          echo "VCPKG_ROOT=$GITHUB_WORKSPACE/target/vcpkg" >> "$GITHUB_ENV"
          echo "RUSTFLAGS=-Ctarget-feature=+crt-static" >> "$GITHUB_ENV"
          echo "VCPKGRS_TRIPLET=x64-windows-static-release" >> "$GITHUB_ENV"
          echo "VCPKG_DEFAULT_HOST_TRIPLET=x64-windows-static-release" >> "$GITHUB_ENV"
          # Format file locking issue workaround:
          echo "RUST_TEST_THREADS=1" >> "$GITHUB_ENV"

      - name: Run Tests
        run: cargo test --workspace --target ${{ matrix.target }}
