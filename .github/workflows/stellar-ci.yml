name: Stellar CI

on:
  push:
    branches:
      - local/ferrotex-vendor-v2
      - main
  pull_request:
    branches:
      - local/ferrotex-vendor-v2
      - main

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install cargo-audit
        uses: taiki-e/install-action@cargo-audit
      - name: Run audit
        run: cargo audit

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Install pkg-config dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfontconfig1-dev libgraphite2-dev libharfbuzz-dev libicu-dev libssl-dev zlib1g-dev
      - name: Run Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  test:
    name: Test
    needs: [audit, fmt, clippy]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      # Linux Deps
      - name: Install Linux Deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfontconfig1-dev libgraphite2-dev libharfbuzz-dev libicu-dev libssl-dev zlib1g-dev

      # macOS Deps (Homebrew)
      - name: Install macOS Deps
        if: runner.os == 'macOS'
        run: |
          brew install graphite2 harfbuzz icu4c openssl
          echo "PKG_CONFIG_PATH=$(brew --prefix icu4c)/lib/pkgconfig:$(brew --prefix openssl)/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

      # Windows Deps (vcpkg - simplified for speed if possible, else rely on cached setup or pre-built)
      # Tectonic's original CI used vcpkg, which is heavy.
      # For "Stellar CI" on a fork, we might want to rely on `tectonic_dep_support` to build generic deps
      # OR use the vcpkg action. Let's try attempting a build without heavy vcpkg first if crates vendor it,
      # but Tectonic relies heavily on external libs.
      # Re-using their vcpkg approach might be safest for Windows.
      # For now, let's stick to standard cargo test and see if it handles vendored deps.
      # Tectonic crates often have 'external-harfbuzz' etc features disabled by default.

      - name: Run Tests
        run: cargo test --workspace
