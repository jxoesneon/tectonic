name: "Deploy"

on:
  workflow_call:
    inputs:
      is-dev:
        required: true
        type: boolean
      is-release:
        required: true
        type: boolean

jobs:
  update-book:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
      - name: "Deployment Setup"
        id: deploy-setup
        uses: ./.github/actions/deploy-setup
        with:
          is-dev: ${{ inputs.is-dev }}
          is-release: ${{ inputs.is-release }}
      - name: "Update book HTML"
        if: ${{ steps.deploy-setup.outputs.top-level != 'skip' }}
        run: |
          # Worth adding better Cranko support for this? reboot-branch is close
          dist/force-push-tree.sh \
            $GITHUB_WORKSPACE/book \
            https://github.com/tectonic-typesetting/book.git \
            "${{ steps.deploy-setup.outputs.top-level }}" \
            "docs mdbook"
        env:
          GITHUB_TOKEN: ${{ secrets.BOOK_TOKEN }}
  recreate-continuous:
    runs-on: ubuntu-latest
    if: ${{ inputs.is-dev }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
      - name: "Deployment Setup"
        id: deploy-setup
        uses: ./.github/actions/deploy-setup
        with:
          is-dev: ${{ inputs.is-dev }}
          is-release: ${{ inputs.is-release }}
          setup-git: 'true'
      - name: "Recreate continuous-deployment GitHub release"
        run: |
          # Allow this to fail, in case the release isn't present
          cranko github delete-release continuous || true
          git tag -f continuous HEAD
          git push -f origin refs/tags/continuous
          cranko github create-custom-release \
            --name "Continuous Deployment" \
            --prerelease \
            --desc "Continuous deployment of commit $(git rev-parse --short HEAD)" \
            continuous
          cranko github upload-artifacts --by-tag continuous \
            $GITHUB_WORKSPACE/binary-*/* \
            $GITHUB_WORKSPACE/appimage/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  branch-and-tag:
    runs-on: ubuntu-latest
    if: ${{ inputs.is-release }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
      - name: "Deployment Setup"
        id: deploy-setup
        uses: ./.github/actions/deploy-setup
        with:
          is-dev: ${{ inputs.is-dev }}
          is-release: ${{ inputs.is-release }}
      - name: "Tag and push"
        run: |
          # cranko release-workflow tag
          echo "Skipping Cranko tagging for manual release"
          git push --tags origin release:release || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CRANKO_HEAD_BRANCH: ${{ github.ref_name }}
  github-releases:
    runs-on: ubuntu-latest
    if: ${{ inputs.is-release }}
    needs: branch-and-tag
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
      - name: "Deployment Setup"
        id: deploy-setup
        uses: ./.github/actions/deploy-setup
        with:
          is-dev: ${{ inputs.is-dev }}
          is-release: ${{ inputs.is-release }}
      - name: "Create per-project GitHub releases"
        run: |
          cranko github create-releases

          if cranko show if-released --exit-code tectonic; then
            cranko github upload-artifacts tectonic \
              $GITHUB_WORKSPACE/binary-*/* \
              $GITHUB_WORKSPACE/appimage/*
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CRANKO_HEAD_BRANCH: ${{ github.ref_name }}
  cargo-publish:
    runs-on: ubuntu-latest
    if: ${{ inputs.is-release }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
      - name: "Deployment Setup"
        id: deploy-setup
        uses: ./.github/actions/deploy-setup
        with:
          is-dev: ${{ inputs.is-dev }}
          is-release: ${{ inputs.is-release }}
      - name: "Rename for jxoesneon fork"
        if: ${{ github.repository == 'jxoesneon/tectonic' }}
        run: |
            version=${GITHUB_REF_NAME#v}
            echo "Renaming to version $version..."
            python3 dist/rename_for_fork.py "$version"
      - name: "Publish updated Cargo crates"
        run: |
          # Publish order matters!
          crates=(
            "crates/errors"
            "crates/status_base"
            "crates/io_base"
            "crates/dep_support"
            "crates/cfg_support"
            "crates/mac_core"
            "crates/bridge_core"
            "crates/bridge_flate"
            "crates/bridge_png"
            "crates/bridge_freetype2"
            "crates/bridge_graphite2"
            "crates/bridge_harfbuzz"
            "crates/bridge_icu"
            "crates/bridge_fontconfig"
            "crates/geturl"
            "crates/xdv"
            "crates/bundles"
            "crates/docmodel"
            "crates/xetex_format"
            "crates/engine_bibtex"
            "crates/pdf_io"
            "crates/engine_xdvipdfmx"
            "crates/xetex_layout"
            "crates/engine_xetex"
            "crates/engine_spx2html"
            "."
          )
          
          for crate in "${crates[@]}"; do
            echo "Publishing $crate..."
            # --no-verify as we might have modified files (renaming)
            # --allow-dirty usually for local only, but in CI we modified tracked files
            # sleep to be nice to crates.io
            cargo publish --token "$CARGO_REGISTRY_TOKEN" --no-verify --allow-dirty --manifest-path "$crate/Cargo.toml" || echo "Failed to publish $crate (already exists?)"
            sleep 10
          done
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          CRANKO_HEAD_BRANCH: ${{ github.ref_name }}
  update-website:
    runs-on: ubuntu-latest
    if: ${{ inputs.is-release }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
      - name: "Deployment Setup"
        id: deploy-setup
        uses: ./.github/actions/deploy-setup
        with:
          is-dev: ${{ inputs.is-dev }}
          is-release: ${{ inputs.is-release }}
          setup-git: 'true'
      - name: "Update GitHub Pages website"
        if: ${{ steps.deploy-setup.outputs.top-level != 'skip' }}
        run: bash dist/update-website.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
